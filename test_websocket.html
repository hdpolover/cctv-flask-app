<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Video Feed Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <h1>WebSocket Video Feed Test</h1>
    <img id="video-feed" alt="Video Feed" style="border: 2px solid black;">
    <div id="status">Connecting...</div>
    <div id="frame-counter">Frames: 0</div>
    <div id="logs" style="height: 200px; overflow-y: scroll; border: 1px solid gray; padding: 10px; margin-top: 10px; font-family: monospace; font-size: 12px;"></div>

    <script>
        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}<br>`;
            logs.scrollTop = logs.scrollHeight;
            console.log('[WS Test]', message);
        }

        log('Initializing WebSocket connection...');
        
        const socket = io();
        let frameCount = 0;

        socket.on('connect', () => {
            log('✅ Connected to server');
            document.getElementById('status').textContent = 'Connected';
        });

        socket.on('disconnect', () => {
            log('❌ Disconnected from server');
            document.getElementById('status').textContent = 'Disconnected';
        });

        socket.on('connect_error', (error) => {
            log('❌ Connection error: ' + error.message);
            document.getElementById('status').textContent = 'Connection Error';
        });

        socket.on('video_frame', (frameData) => {
            frameCount++;
            log(`📹 Received frame #${frameCount}, size: ${frameData ? frameData.length : 'null'} chars`);
            
            const videoFeed = document.getElementById('video-feed');
            if (videoFeed && frameData) {
                videoFeed.src = `data:image/jpeg;base64,${frameData}`;
                document.getElementById('frame-counter').textContent = `Frames: ${frameCount}`;
                log('✅ Frame updated successfully');
            } else {
                log('❌ Failed to update frame - missing element or data');
            }
        });

        socket.on('counter_update', (data) => {
            log('📊 Counter update: ' + JSON.stringify(data));
        });

        socket.on('system_status', (status) => {
            log('🔧 System status: ' + JSON.stringify(status));
        });

        log('WebSocket event handlers set up');
    </script>
</body>
</html>
